import"./hoisted.CmKvcf_A.js";class r{id;ctx;x;y;w;h;text;icon;bg;font_size;color;side;static scale=1;constructor(s,i,l,g,d,u,x,y){this.id=y??Math.random()*1e6,this.ctx=s,this.x=i.left,this.y=i.top,this.w=i.width,this.h=i.height,this.text=l,this.icon=new Image,this.icon.src=u,this.icon.onload=()=>{this.drawIcon()},this.bg=g,this.color=d,this.side=x??"bottom",this.font_size=16}updateIcon(s){this.icon.src=s}updateText(s){this.text=s;const i=this.ctx.measureText(s);this.w=i.width+48}move(s,i){this.x=s,this.y=i}drawTip(){const s=r.scale,i=this.x+s*this.w/2-s*24;switch(this.side){case"left":this.ctx.beginPath(),this.ctx.moveTo(i-s*40,this.y-s*10),this.ctx.lineTo(i-s*60,this.y),this.ctx.lineTo(i-s*40,this.y+s*10),this.ctx.closePath(),this.ctx.fill();break;case"right":this.ctx.beginPath(),this.ctx.moveTo(i+s*40,this.y-s*10),this.ctx.lineTo(i+s*60,this.y),this.ctx.lineTo(i+s*40,this.y+s*10),this.ctx.closePath(),this.ctx.fill();break;case"top":this.ctx.beginPath(),this.ctx.moveTo(i-s*10,this.y-s*5),this.ctx.lineTo(i,this.y-s*25),this.ctx.lineTo(i+s*10,this.y-s*5),this.ctx.closePath(),this.ctx.fill();break;default:this.ctx.beginPath(),this.ctx.moveTo(i-s*10,this.y+s*5),this.ctx.lineTo(i,this.y+s*25),this.ctx.lineTo(i+s*10,this.y+s*5),this.ctx.closePath(),this.ctx.fill();break}}drawBody(){const s=r.scale;this.ctx.beginPath(),this.ctx.roundRect(this.x-s*24,this.y-s*this.h/2,s*this.w,s*this.h,s*5),this.ctx.closePath(),this.ctx.fill()}drawIcon(){this.color&&(this.ctx.filter="invert(1)");const s=r.scale;this.ctx.drawImage(this.icon,this.x-s*20,this.y-s*12,s*24,s*24),this.ctx.filter="none"}drawPin(){this.ctx.fillStyle=this.bg,this.drawTip(),this.drawBody(),this.ctx.fillStyle=this.color,this.drawIcon();const s=r.scale,i=this.font_size*s;this.ctx.font=`${i}px sans-serif`,this.ctx.fillText(this.text,this.x+s*8,this.y+s*6)}isMouseOver(s,i){const l=r.scale;return s>this.x-l*30&&s<this.x-l*16+l*this.w&&i>this.y-l*20&&i<this.y+l*this.h}twin(s){return new r(s,{left:this.x,top:this.y,width:this.w,height:this.h},this.text,this.bg,this.color,this.icon.src,this.side)}clone(){return new r(this.ctx,{left:this.x,top:this.y,width:this.w,height:this.h},this.text,this.bg,this.color,this.icon.src,this.side,this.id)}}class Y{undos;curr;redos;constructor(){this.undos=[],this.redos=[],this.curr=[]}update(s){this.undos.push([...this.curr]),this.curr=[...s],this.redos=[],this.print("Update:")}undo(){const s=this.undos.pop();return s&&(this.redos.push([...this.curr]),this.curr=s),this.print("Undo:"),this.curr}redo(){const s=this.redos.pop();return s&&(this.undos.push([...this.curr]),this.curr=s),this.print("Redo:"),this.curr}print(s){console.log(s)}}function D(){const f=document.getElementById("hi");f.addEventListener("close",()=>{console.log("hi dialog closed")}),f.showModal();const s=document.getElementById("help");s.addEventListener("close",()=>{console.log("help dialog closed")});const i=document.getElementById("btnStart");i.addEventListener("click",()=>{console.log("start clicked"),f.close()}),console.log("init");const l=document.getElementById("pcanvas");if(!l){console.log("no canvas");return}const g=l.getContext("2d"),d=document.getElementById("canvas"),u=d.getContext("2d");document.onkeyup=t=>{t.ctrlKey&&t.key==="s"&&y(),t.ctrlKey&&t.key==="z"&&w(),t.ctrlKey&&t.key==="y"&&E()};const x=document.getElementById("save");function y(){const t=document.createElement("a");t.download=C,t.href=d.toDataURL(),t.click()}x.onclick=y;const P=document.getElementById("saveQ");P.onclick=()=>{console.log("saveQ"),s.showModal(),console.log("help dialog opened")};const z=document.getElementById("undo");function w(){const t=e.history.undo();console.log("undo",t),t&&(e.placed=t,a())}z.onclick=w;const M=document.getElementById("redo");function E(){const t=e.history.redo();console.log("redo",t),t&&(e.placed=t,a())}M.onclick=E;const O=document.getElementById("pick"),v=new Image;let p=new r(g,{top:40,left:60,width:100,height:30},"Pin Text","#7711BB","white","/assets/pins/outlined/dot.svg");function h(){g.clearRect(0,0,g.canvas.width,g.canvas.height),p.drawPin()}const b=new Image;b.src="/assets/pins/outlined/dot.svg",b.onload=()=>{console.log("icon loaded"),h()};const I=document.getElementById("sides"),B=document.getElementById("icons"),k=document.getElementById("pinColor"),L=document.getElementById("txtColor"),_=document.getElementById("pinText"),e={placed:[],held:null,edit_pin:null,canvasHover:!1,pcanvasHover:!1,pin_offset_x:0,pin_offset_y:0,dirty:!1,zoom:1,history:new Y};d.addEventListener("mouseenter",t=>{e.canvasHover=!0,e.held&&(p.move(60,40),e.held=e.held.twin(u),h())}),l.addEventListener("mouseenter",t=>{e.pcanvasHover=!0}),d.addEventListener("mouseleave",t=>{e.canvasHover=!1,e.held&&(console.log("left canvas"),e.held=null,a())}),l.addEventListener("mouseleave",t=>{e.pcanvasHover=!1}),document.addEventListener("mousemove",t=>{if(e.held){if(e.canvasHover){const n=d.getBoundingClientRect(),o=t.clientX-n.left,c=t.clientY-n.top;e.held.move(o,c),a()}if(e.pcanvasHover){const n=l.getBoundingClientRect(),o=t.clientX-n.left,c=t.clientY-n.top;e.held.move(o,c),h()}}}),d.addEventListener("mousedown",t=>{if(!e.canvasHover)return;const n=d.getBoundingClientRect(),o=t.clientX-n.left,c=t.clientY-n.top;for(let m=0;m<e.placed.length;m++){const H=e.placed[m];if(H.isMouseOver(o,c)){d.style.cursor="grabbing",e.held=H,e.placed.splice(m,1),R();return}}}),l.addEventListener("mousedown",t=>{const n=l.getBoundingClientRect(),o=t.clientX-n.left,c=t.clientY-n.top;p.isMouseOver(o,c)&&(l.style.cursor="grabbing",e.held=p,R())});function U(){if(console.log("placing pin"),!e.held)return;const t=l.getBoundingClientRect(),n=e.held.x,o=e.held.y+t.top;T(n,o);const c=e.held.clone();e.placed.push(c),e.history.update(e.placed),S(c),e.held=null,a(),console.log("pin placed")}function S(t){e.edit_pin=t,I.value=t.side;const n=t.icon.src.indexOf("/assets");if(n<0){console.log("no assets");return}const o=t.icon.src.slice(n);B.value=o,k.value=t.bg,L.value=t.color,_.value=t.text}function T(t,n){const o=document.getElementById("edit");o.style.top=n+"px",o.style.left=t+"px",o.classList.add("show")}function R(){const t=document.getElementById("edit");t.classList.contains("show")&&(t.classList.remove("show"),e.edit_pin=null)}document.addEventListener("mouseup",t=>{if(d.style.cursor="grab",l.style.cursor="grab",!!e.held){if(e.canvasHover)U();else if(e.pcanvasHover){e.held=null,p.move(60,40);const n=l.getBoundingClientRect(),o=p.x+n.left,c=p.y+n.top;e.edit_pin=p,T(o,c),h()}e.pin_offset_x=0,e.pin_offset_y=0}}),I.addEventListener("change",t=>{if(!e.edit_pin){console.log("no pin");return}const n=t.target;e.edit_pin.side=n.value,e.history.update(e.placed),h(),a(),console.log("side changed")}),B.addEventListener("change",t=>{if(!e.edit_pin){console.log("no pin");return}const n=t.target;console.log(n.value),e.edit_pin.updateIcon(n.value),e.history.update(e.placed),h(),a(),console.log("icon changed")}),k.addEventListener("change",t=>{if(!e.edit_pin){console.log("no pin");return}const n=t.target;e.edit_pin.bg=n.value,e.history.update(e.placed),h(),a(),console.log("color changed")}),L.addEventListener("change",t=>{if(!e.edit_pin){console.log("no pin");return}const n=t.target;e.edit_pin.color=n.value,e.history.update(e.placed),h(),a(),console.log("text color changed")}),_.addEventListener("change",t=>{if(!e.edit_pin){console.log("no pin");return}const n=t.target;e.edit_pin.updateText(n.value),h(),a(),console.log("text changed")}),document.getElementById("sizes").addEventListener("change",t=>{const n=t.target;r.scale=parseFloat(n.value),e.history.update(e.placed),h(),a(),console.log("size changed")});let C="";O.addEventListener("change",t=>{const n=t.target;if(!n.files||n.files.length<1){alert("No image files selected.");return}if(n.files.length>1){alert("One image file at a time.");return}const o=n.files[0],c=URL.createObjectURL(o);v.src=c,v.onload=()=>{C=o.name.slice(0,-3)+"jpg",x.disabled=!1,e.dirty=!0,X(v),h(),a(),i.disabled=!1}});function X(t){const{width:n,height:o}=t;let c=1;n<600&&(c=600/n),u.canvas.width=c*n,u.canvas.height=c*o,g.canvas.width=c*n,l.style.width=c*n+"px",d.style.width=c*n+"px",d.style.height=c*o+"px"}function a(){u.clearRect(0,0,d.width,d.height),v.src&&u.drawImage(v,0,0,u.canvas.width,u.canvas.height);for(let t=0;t<e.placed.length;t++)e.placed[t].drawPin();e.held&&e.held.drawPin()}console.log("adding event listener"),window.addEventListener("beforeunload",t=>{t.preventDefault(),t.returnValue="Are you sure you want to leave?",e.dirty&&console.log("dirty"),f.open&&(t.preventDefault(),t.returnValue="",f.close(),console.log("closed hi"))})}document.addEventListener("astro:page-load",D);
